#!/usr/bin/env bash
# cysic_install_and_run.sh
# Re-attach later: screen -r cysic-verifer

set -euo pipefail

############################################################
# 1. Ensure GNU screen is installed
############################################################
if ! command -v screen >/dev/null 2>&1; then
  echo "Error: GNU screen is not installed."
  echo "Install it (e.g., sudo apt install screen) and run this script again."
  exit 1
fi

############################################################
# 2. Prompt for and validate wallet address
############################################################
while true; do
  read -rp "Enter your reward address (0x‚Ä¶): " REWARD_ADDR
  if [[ $REWARD_ADDR =~ ^0x[0-9a-fA-F]{40}$ ]]; then
    break
  fi
  echo "‚ùå Invalid format. Must be 0x followed by exactly 40 hex characters."
done

############################################################
# 3. Download and run setup_linux.sh
############################################################
echo "‚¨áÔ∏è  Downloading setup_linux.sh ‚Ä¶"
curl -fsSL \
  https://github.com/cysic-labs/cysic-phase3/releases/download/v1.0.0/setup_linux.sh \
  -o /tmp/setup_linux.sh

chmod +x /tmp/setup_linux.sh
echo "‚ñ∂Ô∏è  Running setup with address $REWARD_ADDR ‚Ä¶"
bash /tmp/setup_linux.sh "$REWARD_ADDR"

############################################################
# 4. Launch the verifier in a **background** screen session
############################################################
SCREEN_NAME="cysic-verifer"              # ‚Üê session name
LOG_FILE="${HOME}/cysic-verifer.log"     # ‚Üê persistent log

# If a session with this name already exists, replace it
if screen -list | grep -q "\.${SCREEN_NAME}[[:space:]]"; then
  echo "‚ÑπÔ∏è  A screen session named \"$SCREEN_NAME\" exists. Replacing it."
  screen -S "$SCREEN_NAME" -X quit || true
fi

echo "üöÄ Launching verifier inside background screen session \"$SCREEN_NAME\" ‚Ä¶"
# -d  start detached   -m  force creation   -L  log to file
screen -dmL -Logfile "$LOG_FILE" -S "$SCREEN_NAME" \
       bash -c 'cd ~/cysic-verifier && bash start.sh'

############################################################
# 5. Quick reference for the user
############################################################
cat <<EOF

‚úÖ The verifier is now running in the background.
   Log file: $LOG_FILE

Useful commands:
  ‚Ä¢ View live console ‚Ä¶  screen -r $SCREEN_NAME
  ‚Ä¢ Detach again ‚Ä¶‚Ä¶      press Ctrl+A then D
  ‚Ä¢ Tail the log ‚Ä¶‚Ä¶‚Ä¶     tail -f $LOG_FILE
  ‚Ä¢ Stop the verifier ‚Ä¶  screen -S $SCREEN_NAME -X quit

You can safely close this terminal.
EOF

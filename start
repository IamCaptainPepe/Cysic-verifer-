#!/usr/bin/env bash
# cysic_install_and_run.sh
# Run with: ./cysic_install_and_run.sh
# Reattach later: screen -r cysic-verifer

set -euo pipefail

#######################################
# Requirements check
#######################################
if ! command -v screen >/dev/null 2>&1; then
  echo "Error: GNU screen is not installed. Please install it (e.g., sudo apt install screen) and try again."
  exit 1
fi

#######################################
# Prompt for and validate wallet address
#######################################
while true; do
  read -rp "Enter your reward address (0x‚Ä¶): " REWARD_ADDR
  if [[ $REWARD_ADDR =~ ^0x[0-9a-fA-F]{40}$ ]]; then
    break
  fi
  echo "‚ùå Invalid format. An EVM address must start with 0x followed by exactly 40 hexadecimal characters."
done

#######################################
# Download and run setup_linux.sh
#######################################
echo "‚¨áÔ∏è  Downloading setup_linux.sh ‚Ä¶"
curl -fsSL \
  https://github.com/cysic-labs/cysic-phase3/releases/download/v1.0.0/setup_linux.sh \
  -o /tmp/setup_linux.sh

chmod +x /tmp/setup_linux.sh
echo "‚ñ∂Ô∏è  Running setup with address $REWARD_ADDR ‚Ä¶"
bash /tmp/setup_linux.sh "$REWARD_ADDR"

#######################################
# Start the verifier in a detached screen session
#######################################
SCREEN_NAME="cysic-verifer"

# If a session with the same name exists, kill it so we can start fresh
if screen -list | grep -q "\.${SCREEN_NAME}[[:space:]]"; then
  echo "‚ÑπÔ∏è  A screen session named \"$SCREEN_NAME\" already exists. Replacing it."
  screen -S "$SCREEN_NAME" -X quit || true
fi

echo "üöÄ Launching verifier inside screen session \"$SCREEN_NAME\" ‚Ä¶"
screen -DmS "$SCREEN_NAME" bash -c 'cd ~/cysic-verifier && bash start.sh'

echo "‚úÖ All done! You can detach/close this terminal safely."
echo "To reattach later:  screen -r cysic-verifer"
